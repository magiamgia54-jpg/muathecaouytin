<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Mua tháº»</title>
</head>
<body>

<h1>ðŸ’³ Mua tháº» cÃ o</h1>
<h3 id="balance">Sá»‘ dÆ°: ...</h3>

<select id="type">
  <option value="10000">Viettel - 10.000Ä‘</option>
  <option value="20000">Viettel - 20.000Ä‘</option>
  <option value="50000">Viettel - 50.000Ä‘</option>
</select>

<br><br>
<button onclick="buy()">Mua ngay</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBK7H8ahk0iOdairoKTYuW6XpXBVTCqUhI",
    authDomain: "wed-mua-the-cao.firebaseapp.com",
    projectId: "wed-mua-the-cao",
    storageBucket: "wed-mua-the-cao.firebasestorage.app",
    messagingSenderId: "893033343634",
    appId: "1:893033343634:web:3627977a944a87ea60d44b"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser;
  let currentBalance = 0;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    currentUser = user;

    const snap = await getDoc(doc(db, "users", user.uid));
    currentBalance = snap.data().balance;

    document.getElementById("balance").innerText =
      "Sá»‘ dÆ°: " + currentBalance.toLocaleString() + "Ä‘";
  });

  window.buy = async function () {
    const price = Number(document.getElementById("type").value);

    if (currentBalance < price) {
      alert("âŒ KhÃ´ng Ä‘á»§ sá»‘ dÆ°");
      return;
    }

    currentBalance -= price;

    await updateDoc(doc(db, "users", currentUser.uid), {
      balance: currentBalance
    });

    document.getElementById("balance").innerText =
      "Sá»‘ dÆ°: " + currentBalance.toLocaleString() + "Ä‘";

    alert("âœ… Mua tháº» thÃ nh cÃ´ng");
  };
</script>

</body>
</html>
