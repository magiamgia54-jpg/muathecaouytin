<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Mua tháº» cÃ o</title>
</head>
<body>

<h2>ðŸ›’ Mua tháº» cÃ o</h2>

<p>Sá»‘ dÆ°: <b><span id="balance">0</span> Ä‘</b></p>

<hr>

<label>NhÃ  máº¡ng:</label>
<select id="network">
  <option value="Viettel">Viettel</option>
  <option value="Mobifone">Mobifone</option>
  <option value="Vinaphone">Vinaphone</option>
</select>

<br><br>

<label>Má»‡nh giÃ¡:</label>
<select id="amount">
  <option value="10000">10.000 Ä‘</option>
  <option value="20000">20.000 Ä‘</option>
  <option value="50000">50.000 Ä‘</option>
  <option value="100000">100.000 Ä‘</option>
</select>

<br><br>

<button onclick="muaThe()">Mua tháº»</button>

<p id="msg"></p>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, increment, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "API_KEY_Cá»¦A_Báº N",
  authDomain: "xxx.firebaseapp.com",
  projectId: "xxx",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

let currentUser;
let currentBalance = 0;

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "index.html";
    return;
  }

  currentUser = user;

  const snap = await getDoc(doc(db, "users", user.uid));
  currentBalance = snap.data().balance;
  document.getElementById("balance").innerText = currentBalance;
});

window.muaThe = async () => {
  const network = document.getElementById("network").value;
  const amount = Number(document.getElementById("amount").value);

  if (currentBalance < amount) {
    document.getElementById("msg").innerText = "âŒ KhÃ´ng Ä‘á»§ tiá»n";
    return;
  }

  // Trá»« tiá»n
  await updateDoc(doc(db, "users", currentUser.uid), {
    balance: increment(-amount)
  });

  // LÆ°u lá»‹ch sá»­ mua
  await addDoc(collection(db, "orders"), {
    uid: currentUser.uid,
    network,
    amount,
    createdAt: serverTimestamp()
  });

  currentBalance -= amount;
  document.getElementById("balance").innerText = currentBalance;

  document.getElementById("msg").innerText = "âœ… Mua tháº» thÃ nh cÃ´ng";
};
</script>

</body>
</html>
