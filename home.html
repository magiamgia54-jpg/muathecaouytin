<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>MuaTh·∫ªCaoUyTin</title>

<style>
body{
  font-family:Arial,sans-serif;
  background:#f4f6f8;
  margin:0;
}
.container{
  max-width:420px;
  margin:30px auto;
  background:#fff;
  padding:20px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,.1)
}
h2{text-align:center}
.balance{
  background:#e8f5e9;
  padding:10px;
  border-radius:6px;
  text-align:center;
  font-weight:bold;
  margin-bottom:15px
}
.cards{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
  margin-bottom:15px
}
.card{
  padding:12px;
  border-radius:8px;
  text-align:center;
  font-weight:bold;
  cursor:pointer;
  border:2px solid transparent
}
.card.active{border-color:#000}
.viettel{background:#e53935;color:#fff}
.vina{background:#1976d2;color:#fff}
.mobi{background:#43a047;color:#fff}
.amount{background:#eee}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:6px;
  background:#1e88e5;
  color:#fff;
  font-size:16px
}
.msg{text-align:center;font-weight:bold;margin-top:10px}
.success{color:green}
.error{color:red}
</style>
</head>

<body>
<div class="container">

<h2>üéÆ MuaTh·∫ªCaoUyTin</h2>

<div class="balance">
  S·ªë d∆∞: <span id="balance">0</span> ƒë
</div>

<b>Nh√† m·∫°ng</b>
<div class="cards">
  <div class="card viettel" onclick="chonMang('Viettel',this)">Viettel</div>
  <div class="card vina" onclick="chonMang('Vinaphone',this)">Vinaphone</div>
  <div class="card mobi" onclick="chonMang('Mobifone',this)">Mobifone</div>
</div>

<b>M·ªánh gi√°</b>
<div class="cards">
  <div class="card amount" onclick="chonTien(10000,this)">10.000</div>
  <div class="card amount" onclick="chonTien(20000,this)">20.000</div>
  <div class="card amount" onclick="chonTien(50000,this)">50.000</div>
  <div class="card amount" onclick="chonTien(100000,this)">100.000</div>
</div>

<button onclick="muaThe()">Mua th·∫ª</button>
<p id="msg" class="msg"></p>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore,doc,getDoc,updateDoc,increment,
  collection,query,where,getDocs,addDoc,limit,serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* üî• D√ÅN FIREBASE CONFIG C·ª¶A B·∫†N */
const firebaseConfig = {
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  projectId: "PROJECT_ID",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

let currentUser;
let currentBalance = 0;
let network = "";
let amount = 0;

window.chonMang = (m,el)=>{
  network=m;
  document.querySelectorAll(".viettel,.vina,.mobi").forEach(e=>e.classList.remove("active"));
  el.classList.add("active");
};

window.chonTien = (t,el)=>{
  amount=t;
  document.querySelectorAll(".amount").forEach(e=>e.classList.remove("active"));
  el.classList.add("active");
};

onAuthStateChanged(auth, async(user)=>{
  if(!user){
    alert("Ch∆∞a ƒëƒÉng nh·∫≠p");
    return;
  }
  currentUser=user;
  const snap=await getDoc(doc(db,"users",user.uid));
  currentBalance=snap.data().balance;
  document.getElementById("balance").innerText=currentBalance;
});

window.muaThe = async()=>{
  const msg=document.getElementById("msg");

  if(!network||!amount){
    msg.innerText="‚ùå Ch·ªçn nh√† m·∫°ng v√† m·ªánh gi√°";
    msg.className="msg error";return;
  }

  if(currentBalance<amount){
    msg.innerText="‚ùå Kh√¥ng ƒë·ªß ti·ªÅn";
    msg.className="msg error";return;
  }

  const q=query(
    collection(db,"cards"),
    where("network","==",network),
    where("amount","==",amount),
    where("used","==",false),
    limit(1)
  );

  const snap=await getDocs(q);
  if(snap.empty){
    msg.innerText="‚ùå H·∫øt th·∫ª";
    msg.className="msg error";return;
  }

  const card=snap.docs[0];

  await updateDoc(doc(db,"users",currentUser.uid),{
    balance:increment(-amount)
  });

  await updateDoc(card.ref,{used:true});

  await addDoc(collection(db,"orders"),{
    uid:currentUser.uid,
    network,
    amount,
    code:card.data().code,
    serial:card.data().serial,
    createdAt:serverTimestamp()
  });

  currentBalance-=amount;
  document.getElementById("balance").innerText=currentBalance;

  msg.className="msg success";
  msg.innerHTML=`‚úÖ Th√†nh c√¥ng<br>M√£: <b>${card.data().code}</b><br>Serial: <b>${card.data().serial}</b>`;
};
</script>

</body>
</html>
